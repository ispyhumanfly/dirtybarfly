#!/usr/bin/env perl

use Modern::Perl;

BEGIN {

    if (-x '/usr/bin/sqlite3') {

        system 'sqlite3 konekt.db < lib/Model/Schema.sql'
          unless -e 'konekt.db';
    }
}

use REST::Google::Search qw/ LOCAL /;
use Crypt::SaltedHash;
use GIS::Distance;
use DateTime;

use lib 'lib';
use Model::Schema;

our $MODEL = Model::Schema->connect('dbi:SQLite:konekt.db');

use Mojolicious::Lite;

### Welcome

get '/' => sub {

    my $self = shift;

    return $self->redirect_to('dashboard', layout => 'default')
      if $self->session('person_id');

    return $self->render('welcome', layout => 'default')
      if not $self->session('person_id');

} => 'welcome';

### Dashboard

get '/dashboard' => sub {

    my $self = shift;
    $self->session(page => 'dashboard');

    return $self->redirect_to('welcome') unless $self->session('person_id');

    my $person = $MODEL->resultset('Person')->search(
        {person_id => $self->session('person_id')},

        {   order_by => 'person_id DESC',
            prefetch => 'tracks',
        }
    )->first;

    for (split /,/, $person->tracking) {

        push @{$self->{'tracking'}}, $MODEL->resultset('Person')->search(
            {person_id => $_},
            {   order_by => 'person_id DESC',
                prefetch => 'tracks',
            }
        )->first;
    }

    $self->{'person'} = $person;

    $self->render('dashboard', layout => 'default');

} => 'dashboard';

### People

get '/people' => sub {

    my $self = shift;
    $self->session(page => 'people');

    return $self->redirect_to('welcome') unless $self->session('person_id');

    my @people = $MODEL->resultset('Person')->search(
        undef,

        {order_by => 'person_id DESC'}
    );

    for (@people) {

        my $distance = get_distance(
            $self->session('lat'), $self->session('lng') => $_->lat,
            $_->lng
        );

        push @{$self->{'people'}}, $_ if $distance <= 3000;    
    }

    $self->render('blank', layout => 'default')
      unless exists $self->{'people'};

    $self->render('people', layout => 'default');

} => 'people';

get '/person/:id' => [id => qr/\d+/] => sub {

    my $self = shift;
    $self->session(page => 'person');

    return $self->redirect_to('welcome')
      unless $self->session('person_id');

    my @people =
      $MODEL->resultset('Person')->search({person_id => $self->param('id')});

    for (@people) {

        $self->session(

            city    => $_->city,
            region  => $_->region,
            country => $_->country,
            lat     => $_->lat,
            lng     => $_->lng,
        );
    }

    $self->{'people'} = \@people;
    $self->render('people', layout => 'default');

};

### Events

get '/events' => sub {

    my $self = shift;
    $self->session(page => 'events');

    return $self->redirect_to('welcome') unless $self->session('person_id');

    my @events = $MODEL->resultset('Event')->search(
        undef,

        {   order_by => 'event_id DESC',
            prefetch => 'comments',
        }
    );

    for (@events) {

        my $distance = get_distance(
            $self->session('lat'), $self->session('lng') => $_->lat,
            $_->lng
        );

        push @{$self->{'events'}}, $_ if $distance <= 3000;    
    }

    $self->render('blank', layout => 'default')
      unless exists $self->{'events'};

    $self->render('events', layout => 'default');

} => 'events';

get '/event/:id' => [id => qr/\d+/] => sub {

    my $self = shift;
    $self->session(page => 'event');

    my @events =
      $MODEL->resultset('Event')->search({event_id => $self->param('id')});

    for (@events) {

        $self->session(

            city    => $_->city,
            region  => $_->region,
            country => $_->country,
            lat     => $_->lat,
            lng     => $_->lng,
        );
    }

    $self->{'events'} = \@events;
    $self->render('events', layout => 'default');

};

### Topics

get '/topics' => sub {

    my $self = shift;
    $self->session(page => 'topics');

    return $self->redirect_to('welcome') unless $self->session('person_id');

    my @topics = $MODEL->resultset('Topic')->search(
        undef,

        {   order_by => 'topic_id DESC',
            prefetch => 'comments',
        }
    );

    for (@topics) {

        my $distance = get_distance(
            $self->session('lat'), $self->session('lng') => $_->lat,
            $_->lng
        );

        push @{$self->{'topics'}}, $_ if $distance <= 3000;    
    }

    $self->render('blank', layout => 'default')
      unless exists $self->{'topics'};

    $self->render('topics', layout => 'default');

} => 'topics';

get '/topic/:id' => [id => qr/\d+/] => sub {

    my $self = shift;
    $self->session(page => 'topic');

    my @topics =
      $MODEL->resultset('Topic')->search({topic_id => $self->param('id')});

    for (@topics) {

        $self->session(

            city    => $_->city,
            region  => $_->region,
            country => $_->country,
            lat     => $_->lat,
            lng     => $_->lng,
        );
    }

    $self->{'topics'} = \@topics;
    $self->render('topics', layout => 'default');

};

## Classifieds

get '/classifieds' => sub {

    my $self = shift;
    $self->session(page => 'classifieds');

    return $self->redirect_to('welcome') unless $self->session('person_id');

    my @classifieds = $MODEL->resultset('Classified')->search(
        undef,

        {   order_by => 'classified_id DESC',
            prefetch => 'comments',
        }
    );

    for (@classifieds) {

        my $distance = get_distance(
            $self->session('lat'), $self->session('lng') => $_->lat,
            $_->lng
        );

        push @{$self->{'classifieds'}}, $_ if $distance <= 3000;    
    }

    $self->render('blank', layout => 'default')
      unless exists $self->{'classifieds'};

    $self->render('classifieds', layout => 'default');

} => 'classifieds';


get '/classified/:id' => [id => qr/\d+/] => sub {

    my $self = shift;
    $self->session(page => 'classified');

    my @classifieds =
      $MODEL->resultset('Classified')
      ->search({classified_id => $self->param('id')});

    for (@classifieds) {

        $self->session(

            city    => $_->city,
            region  => $_->region,
            country => $_->country,
            lat     => $_->lat,
            lng     => $_->lng,
        );
    }

    $self->{'classifieds'} = \@classifieds;
    $self->render('classifieds', layout => 'default');

};

## Commands

post '/signin' => sub {

    my $self = shift;

    if (($self->param('name')) and ($self->param('password'))) {

        my @people =
          $MODEL->resultset('Person')->search({name => $self->param('name')});

        for (@people) {

            if (Crypt::SaltedHash->validate(
                    $_->password, $self->param('password'), 8
                )
              )
            {

                $self->session(

                    person_id => $_->person_id,
                    name      => $_->name,
                    city      => $_->city,
                    region    => $_->region,
                    country   => $_->country,
                    lat       => $_->lat,
                    lng       => $_->lng
                );

                return $self->redirect_to('welcome');
            }
        }
    }

    return $self->redirect_to('dashboard');

};

post '/register' => sub {

    my $self = shift;

    if (    ($self->param('name'))
        and ($self->param('location'))
        and ($self->param('email_1'))
        and ($self->param('email_2'))
        and ($self->param('password_1'))
        and ($self->param('password_2')))
    {

        return if $self->param('email_1')    ne $self->param('email_2');
        return if $self->param('password_1') ne $self->param('password_2');
        
        my @results = google_local($self->param('location'));
        
        for (@results) {
    
            my $new_person = $MODEL->resultset('Person')->create(
    
                {   name  => $self->param('name'),
                    email => $self->param('email_1'),
                    password =>
                      salt_password($self->param('password_1')),
                    city       => $_->city,
                    region     => $_->region,
                    country    => $_->country,
                    avatar     => '/avatar.png',
                    blurb      => 'This place is cool!',
                    lat        => $_->lat,
                    lng        => $_->lng,
                    datetime   => DateTime->now,
                }
            );
    
            $self->session(
    
                person_id => $new_person->person_id,
                name      => $new_person->name,
                email     => $new_person->email,
                city      => $new_person->city,
                region    => $new_person->region,
                country   => $new_person->country,
                lat       => $new_person->lat,
                lng       => $new_person->lng,
            );
        }
    }
    
    return $self->redirect_to('dashboard');

};

get '/signout' => sub {

    my $self = shift;

    $self->session(expires => 1);
    $self->redirect_to('welcome');

};

post '/location' => sub {

    my $self = shift;

    if ($self->param('location')) {

        my @results = google_local($self->param('location'));

        for (@results) {

            $self->session(

                city    => $_->city,
                region  => $_->region,
                country => $_->country,
                lat     => $_->lat,
                lng     => $_->lng,
            );
        }
    }

    return $self->redirect_to($self->session('page'));

};

post '/tracking/:type/:id' => [type => qr/\w+/, id => qr/\d+/] => sub {

    my $self = shift;

    if ($self->param('type') eq 'person') {

        my $person =
          $MODEL->resultset('Person')
          ->search({person_id => $self->session('person_id')})->first;

        my @current_tracking = split /,/, $person->tracking;

        my @new_tracking;

        for (@current_tracking) {

            push @new_tracking, $_ unless $_ == $self->param('id');
        }

        if ($self->param('start')) {

            push @new_tracking, $self->param('id');

            my $csv = join ',', @new_tracking;

            $MODEL->resultset('Person')
              ->search({person_id => $self->session('person_id')})
              ->update({tracking => $csv});
        }
        elsif ($self->param('stop')) {

            my $csv = join ',', @new_tracking;

            $MODEL->resultset('Person')
              ->search({person_id => $self->session('person_id')})
              ->update({tracking => $csv});
        }
    }

};

post '/submit/:type' => [type => qr/\w+/] => sub {

    my $self = shift;

    if ($self->param('type') eq 'event') {

        my @results = google_local($self->param('location'));
        
        for (@results) {

            my $event = $MODEL->resultset('Event')->create(

                {   category       => $self->param('category'),
                    title          => $self->param('title'),
                    start_datetime => $self->param('start_date'),
                    stop_datetime  => $self->param('stop_date'),
                    about          => $self->param('about'),
                    street_address => $_->streetAddress,
                    city           => $_->city,
                    region         => $_->region,
                    country        => $_->country,
                    lat            => $_->lat,
                    lng            => $_->lng,
                    datetime       => DateTime->now,
                    person         => $self->session('person_id'),
                }
            );

            my $person_track = $MODEL->resultset('PersonTrack')->create(

                {   datetime => DateTime->now,
                    comment  => 'Just submitted a event to Konekt.',
                    link     => '/event/' . $event->event_id,
                    person   => $self->session('person_id'),
                }
            );
        }
    }

    elsif ($self->param('type') eq 'topic') {

        my @results = google_local($self->param('location'));
        
        for (@results) {

            my $topic = $MODEL->resultset('Topic')->create(

                {   category       => $self->param('category'),
                    title          => $self->param('title'),
                    about          => $self->param('about'),
                    street_address => $_->streetAddress,
                    city           => $_->city,
                    region         => $_->region,
                    country        => $_->country,
                    lat            => $_->lat,
                    lng            => $_->lng,
                    datetime       => DateTime->now,
                    person         => $self->session('person_id'),
                }
            );

            my $person_track = $MODEL->resultset('PersonTrack')->create(

                {   datetime => DateTime->now,
                    comment  => 'Just submitted a topic to Konekt.',
                    link     => '/topic/' . $topic->topic_id,
                    person   => $self->session('person_id'),
                }
            );
        }
    }

    elsif ($self->param('type') eq 'classified') {

        my @results = google_local($self->param('location'));
        
        for (@results) {

            my $classified = $MODEL->resultset('Classified')->create(

                {   category       => $self->param('category'),
                    title          => $self->param('title'),
                    about          => $self->param('about'),
                    street_address => $_->streetAddress,
                    city           => $_->city,
                    region         => $_->region,
                    country        => $_->country,
                    lat            => $_->lat,
                    lng            => $_->lng,
                    price          => $self->param('price'),
                    datetime       => DateTime->now,
                    person         => $self->session('person_id'),
                }
            );

            my $person_track = $MODEL->resultset('PersonTrack')->create(

                {   datetime => DateTime->now,
                    comment  => 'Just submitted a classified to Konekt.',
                    link     => '/classified/' . $classified->classified_id,
                    person   => $self->session('person_id'),
                }
            );
        }
    }

    return $self->redirect_to($self->session('page'));

};

post '/update/:type/:id' => [type => qr/\w+/, id => qr/\d+/] => sub {

    my $self = shift;

    if ($self->param('type') eq 'person') {

        return if $self->param('password_1') ne $self->param('password_2');

        my @results = google_local($self->param('location'));

        for (@results) {

            $MODEL->resultset('Person')
              ->search({person_id => $self->param('id')})->update(
                {   name       => $self->param('name'),
                    first_name => $self->param('first_name'),
                    last_name  => $self->param('last_name'),
                    gender     => $self->param('gender'),
                    birthday   => $self->param('birthday'),
                    email      => $self->param('email'),
                    city       => $_->city,
                    region     => $_->region,
                    country    => $_->country,
                    lat        => $_->lat,
                    lng        => $_->lng,
                    avatar     => $self->param('avatar'),
                    blurb      => $self->param('blurb'),
                    password   => salt_password($self->param('password_1'))
                }
              );
        }
    }

    return $self->redirect_to('dashboard');

};

### Tools

sub salt_password {

    my $crypt = Crypt::SaltedHash->new(

        algorithm => 'SHA-256',
        salt_len  => 8, 
    );

    $crypt->add(shift);

    return $crypt->generate;

}

sub get_distance {

    my $geo = GIS::Distance->new();

    my $distance = $geo->distance(shift);
    
    return 50; #$distance->meters;

}

sub google_local {
    
    REST::Google::Search->service(LOCAL);

    my $response =
      REST::Google::Search->new(q => shift);

    if ($response->responseStatus == 200) {

        my $data = $response->responseData;
        return $data->results;
    }
    
}

app->secret('Insurgent Software Rocks!');
app->start;
