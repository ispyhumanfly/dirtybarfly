#!/usr/bin/env perl

use Mojolicious::Lite;
use Moose;
use KiokuDB;

my $DATA = KiokuDB->connect( "dbi:SQLite:dbname=socialmap.db", create => 1 );

#### Pages...

get '/' => sub {

    my $self = shift;
    $self->render( 'index', layout => 'default' );

} => 'index';

get '/places' => sub {

    my $self = shift;
    $self->render( 'places', layout => 'default' );
    
    return $self->redirect_to('index') unless $self->session('name');

} => 'places';

get '/stories' => sub {

    my $self = shift;
    $self->render( 'stories', layout => 'default' );
    
    return $self->redirect_to('index') unless $self->session('name');

} => 'stories';

get '/ads' => sub {

    my $self = shift;
    $self->render( 'ads', layout => 'default' );
    
    return $self->redirect_to('index') unless $self->session('name');

} => 'ads';

#### Functions...

get '/login' => sub {

    my $self = shift;

    if ( $self->param('name') ) {
        
        my $name = $self->param('name');

        $self->session( name => $name );
        $self->redirect_to('index');
    }
    else {

        return $self->render        
    }

} => 'login';

get '/logout' => sub {

    my $self = shift;

    $self->session( expires => 1 );
    $self->redirect_to('index');

} => 'logout';


#### Forms...

post '/search' => sub {

    my $self = shift;

    if ( $self->param('value') ) {
        
        my $value = $self->param('value');
        $self->session( search => $value );
    }

} => 'search';

post '/post' => sub {

    my $self = shift;
    
    use lib 'lib';
    
    my $scope = $DATA->new_scope;

    if ( $self->param('type') eq 'place' ) {
        
    use Posts;
    
    my $post_id = $DATA->store(
        
        Posts->new(
    
        type        => $self->param('type'),
        category    => $self->param('category'),
        title       => $self->param('title'),
        body        => $self->param('body'),
    ));
    
    }
    
    $self->redirect_to('index');

} => 'post';

app->secret('SocialMAP Rocks!');
app->start;
