#!/usr/bin/env perl

use Mojolicious::Lite;

use lib 'lib';
use Model::Schema;

my $MODEL = Model::Schema->connect('dbi:SQLite:socialmap.db');

#### Pages...

get '/' => sub {

    my $self = shift;
    
    $self->render( 'index', layout => 'default' );

} => 'index';

get '/places' => sub {

    my $self = shift;

    my @places = $MODEL->resultset('Places')->search();
    
    $self->{'places'} = \@places;

    $self->render( 'places', layout => 'default' );
    return $self->redirect_to('index') unless $self->session('name');

} => 'places';

get '/stories' => sub {

    my $self = shift;
    
    my @stories = $MODEL->resultset('Stories')->search();
    
    $self->{'stories'} = \@stories;
    
    $self->render( 'stories', layout => 'default' );
    return $self->redirect_to('index') unless $self->session('name');

} => 'stories';

get '/ads' => sub {

    my $self = shift;

    my @ads = $MODEL->resultset('Ads')->search();
    
    $self->{'ads'} = \@ads;

    $self->render( 'ads', layout => 'default' );
    return $self->redirect_to('index') unless $self->session('name');

} => 'ads';

#### Functions...

get '/login' => sub {

    my $self = shift;

    if ( $self->param('name') ) {

        my $name = $self->param('name');

        $self->session( name => $name );
        $self->redirect_to('index');
    }
    else {

        return $self->render;
    }

} => 'login';

get '/logout' => sub {

    my $self = shift;

    $self->session( expires => 1 );
    $self->redirect_to('index');

} => 'logout';

#### Forms...

post '/search' => sub {

    my $self = shift;

    if ( $self->param('value') ) {

        my $value = $self->param('value');
        $self->session( search => $value );
    }

} => 'search';

post '/post' => sub {

    my $self = shift;

    my ( $sec, $min, $hour, $mday, $mon, $year, $wday, $yday, $isdst ) =
      localtime(time);

    if ( $self->param('table') eq 'places' ) {

        my $place = $MODEL->resultset('Places')->create(

            {
                category => $self->param('category'),
                title    => $self->param('title'),
                body     => $self->param('body'),
                date     => "$year-$mon-$mday",
                time     => "$hour:$min:$sec",
                epoch    => 210,
            }
        );
    }

    if ( $self->param('table') eq 'stories' ) {

        my $story = $MODEL->resultset('Stories')->create(

            {
                category => $self->param('category'),
                title    => $self->param('title'),
                body     => $self->param('body'),
                date     => "$year-$mon-$mday",
                time     => "$hour:$min:$sec",
                epoch    => 210,
            }
        );
    }

    if ( $self->param('table') eq 'ads' ) {

        my $ad = $MODEL->resultset('Ads')->create(

            {
                category => $self->param('category'),
                title    => $self->param('title'),
                body     => $self->param('body'),
                date     => "$year-$mon-$mday",
                time     => "$hour:$min:$sec",
                epoch    => 210,
            }
        );
    }

    $self->redirect_to($self->param('table'));

} => 'post';

app->secret('SocialMAP Rocks!');
app->start;
